<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Validaci√≥n Referidos - Soluci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Validaci√≥n de C√≥digos de Referido - Soluci√≥n Aplicada</h1>
        <p>Este test verifica que la soluci√≥n al problema de validaci√≥n de c√≥digos de referido funciona correctamente.</p>
        
        <div class="test-section">
            <h2>üìã Problemas Solucionados:</h2>
            <ul>
                <li>‚úÖ Estructura de respuesta del servicio corregida</li>
                <li>‚úÖ C√≥digo de referido no editable cuando viene de link</li>
                <li>‚úÖ C√≥digo de referido editable en registro general</li>
                <li>‚úÖ Validaci√≥n consistente entre frontend y backend</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üß™ Test 1: Validaci√≥n de C√≥digo V√°lido</h2>
            <input type="text" id="validCode" placeholder="C√≥digo v√°lido" value="PARENT001">
            <button onclick="testValidCode()">Validar C√≥digo V√°lido</button>
            <div id="validResult"></div>
        </div>

        <div class="test-section">
            <h2>üß™ Test 2: Validaci√≥n de C√≥digo Inv√°lido</h2>
            <input type="text" id="invalidCode" placeholder="C√≥digo inv√°lido" value="INVALID123">
            <button onclick="testInvalidCode()">Validar C√≥digo Inv√°lido</button>
            <div id="invalidResult"></div>
        </div>

        <div class="test-section">
            <h2>üß™ Test 3: Simulaci√≥n de Link de Referido</h2>
            <p>Simula el comportamiento cuando un usuario llega desde un link de referido:</p>
            <button onclick="simulateReferralLink()">Simular Link con PARENT001</button>
            <div id="linkResult"></div>
        </div>

        <div class="test-section info">
            <h2>üìù Instrucciones de Prueba Manual:</h2>
            <ol>
                <li><strong>Registro General:</strong> Ve a <a href="http://localhost:5173/register" target="_blank">http://localhost:5173/register</a> - El c√≥digo debe ser editable</li>
                <li><strong>Link de Referido:</strong> Ve a <a href="http://localhost:5173/register?ref=PARENT001" target="_blank">http://localhost:5173/register?ref=PARENT001</a> - El c√≥digo debe ser no editable</li>
                <li><strong>Validaci√≥n:</strong> Intenta registrarte con c√≥digos v√°lidos e inv√°lidos para verificar la validaci√≥n</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        async function testValidCode() {
            const code = document.getElementById('validCode').value;
            const resultDiv = document.getElementById('validResult');
            await testCode(code, resultDiv, 'v√°lido');
        }

        async function testInvalidCode() {
            const code = document.getElementById('invalidCode').value;
            const resultDiv = document.getElementById('invalidResult');
            await testCode(code, resultDiv, 'inv√°lido');
        }

        async function testCode(code, resultDiv, expectedType) {
            try {
                resultDiv.innerHTML = '<div class="result info">Validando...</div>';
                
                const response = await axios.get(`${API_BASE}/referrals/validate/${code}`);
                console.log('Respuesta completa:', response.data);
                
                const isValid = response.data.success && response.data.data?.valid;
                
                if (isValid) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            ‚úÖ C√≥digo ${expectedType === 'v√°lido' ? 'V√ÅLIDO' : 'V√ÅLIDO (inesperado)'}: ${response.data.data.message}<br>
                            üë§ Usuario: ${response.data.data.user?.name} (${response.data.data.user?.email})
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result ${expectedType === 'inv√°lido' ? 'success' : 'error'}">
                            ${expectedType === 'inv√°lido' ? '‚úÖ' : '‚ùå'} C√≥digo ${expectedType === 'inv√°lido' ? 'INV√ÅLIDO (esperado)' : 'INV√ÅLIDO (inesperado)'}: ${response.data.data?.message || 'C√≥digo no v√°lido'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        ‚ùå Error de conexi√≥n: ${error.message}<br>
                        Verifica que el backend est√© ejecut√°ndose en ${API_BASE}
                    </div>
                `;
            }
        }

        async function simulateReferralLink() {
            const resultDiv = document.getElementById('linkResult');
            resultDiv.innerHTML = `
                <div class="result info">
                    üîó Simulando link de referido...<br>
                    <strong>URL:</strong> http://localhost:5173/register?ref=PARENT001<br>
                    <strong>Comportamiento esperado:</strong> C√≥digo no editable, validaci√≥n autom√°tica
                </div>
            `;
            
            // Abrir en nueva ventana
            setTimeout(() => {
                window.open('http://localhost:5173/register?ref=PARENT001', '_blank');
                resultDiv.innerHTML += `
                    <div class="result success">
                        ‚úÖ Ventana abierta. Verifica que el c√≥digo PARENT001 aparezca como no editable.
                    </div>
                `;
            }, 1000);
        }

        // Ejecutar test autom√°tico al cargar
        window.onload = () => {
            console.log('üöÄ Iniciando tests autom√°ticos...');
            setTimeout(() => testValidCode(), 1000);
            setTimeout(() => testInvalidCode(), 2000);
        };
    </script>
</body>
</html>